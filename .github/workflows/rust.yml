name: Rust

on: [push]

jobs:
  lint:
    runs-on: ubuntu-18.04
    steps:
    - uses: actions/checkout@v2
    - name: style
      run: cargo fmt -- --check
    - name: clippy
      run: cargo clippy --all-targets --all-features -- -D warnings

  test-amd64:
    runs-on: ubuntu-18.04
    steps:
    - uses: actions/checkout@v2
    - name: test
      run: cargo test

  test-i686:
    runs-on: ubuntu-18.04
    steps:
    - uses: actions/checkout@v2
    - name: setup
      run: rustup target add i686-unknown-linux-gnu
    - name: test
      run: cargo test --target i686-unknown-linux-gnu

  test-aarch64:
    runs-on: ubuntu-18.04
    steps:
    - uses: actions/checkout@v2
    - uses: uraimo/run-on-arch-action@v1.0.9
      id: test-run
      with:
        architecture: aarch64
        distribution: ubuntu18.04
        run: |
          cargo test > output.txt
          echo ::set-output name=test::$(cat output.txt)
    - name: test-output
      run: echo "${{ steps.test.outputs.test }}"

  build-wasm32:
    runs-on: ubuntu-18.04
    steps:
    - uses: actions/checkout@v2
    - name: setup
      run: rustup target add wasm32-unknown-unknown
    - name: build
      run: cargo build --target wasm32-unknown-unknown
